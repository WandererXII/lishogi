var Shogiground=function(){"use strict";function e(e){return"PIECE"===e.tagName}function o(e){return"SQ"===e.tagName}const t=["sente","gote"],n=["1","2","3","4","5","6","7","8","9","10","11","12"],r=["a","b","c","d","e","f","g","h","i","j","k","l"],s=Array.prototype.concat(...r.map((e=>n.map((o=>o+e))))),i=e=>s[e[0]+12*e[1]],a=e=>e.length>2?[e.charCodeAt(1)-39,e.charCodeAt(2)-97]:[e.charCodeAt(0)-49,e.charCodeAt(1)-97];function d(e){let o;const t=()=>(void 0===o&&(o=e()),o);return t.clear=()=>{o=void 0},t}function c(e,...o){e&&setTimeout((()=>e(...o)),1)}const l=e=>"sente"===e?"gote":"sente",u=e=>"sente"===e,p=(e,o)=>{const t=e[0]-o[0],n=e[1]-o[1];return t*t+n*n},f=(e,o)=>e.role===o.role&&e.color===o.color,g=(e,o,t,n,r)=>[(t?o.files-1-e[0]:e[0])*n,(t?e[1]:o.ranks-1-e[1])*r],h=e=>(o,t)=>g(o,e,t,100,100),m=(e,o,t)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${t}`},v=(e,o,t,n)=>{e.style.transform=`translate(${o[0]*t}%,${o[1]*t}%) scale(${n||t})`},b=(e,o)=>{e.style.display=o?"":"none"},w=e=>{var o;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(o=e.targetTouches)||void 0===o?void 0:o[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},C=e=>2===e.buttons||2===e.button,k=(e,o)=>{const t=document.createElement(e);return o&&(t.className=o),t};function y(e){return`${e.color} ${e.role}`}function P(e,o,t,n){const r=a(e);return o&&(r[0]=t.files-1-r[0],r[1]=t.ranks-1-r[1]),[n.left+n.width*r[0]/t.files+n.width/(2*t.files),n.top+n.height*(t.ranks-1-r[1])/t.ranks+n.height/(2*t.ranks)]}function M(e,o,t){const n=a(e);let r=t.files-1-n[0]+n[1]*t.files;return o||(r=t.files*t.ranks-1-r),r}function S(e,o){return e.left<=o[0]&&e.top<=o[1]&&e.left+e.width>o[0]&&e.top+e.height>o[1]}function O(e,o,t,n){let r=Math.floor(t.files*(e[0]-n.left)/n.width);o&&(r=t.files-1-r);let s=Math.floor(t.ranks*(e[1]-n.top)/n.height);return o||(s=t.ranks-1-s),r>=0&&r<t.files&&s>=0&&s<t.ranks?i([r,s]):void 0}function D(e,o,n){for(const r of t)for(const t of o){const o={color:r,role:t},s=n.get(y(o));if(s&&S(s,e))return o}}function q(e,o,t,n,r){const s=r.width/n.files,i=r.height/n.ranks;let a=(e-r.left)/s;t&&(a=n.files-1-a);let d=(o-r.top)/i;return t||(d=n.ranks-1-d),[a,d]}function B(e,o){return Math.abs(e-o)}const E=(e,o,t,n)=>B(e,t)===B(o,n),L=(e,o,t,n)=>e===t||o===n,R=(e,o,t,n)=>B(e,t)<2&&B(o,n)<2;const A=(e,o,t,n)=>R(e,o,t,n)||E(e,o,t,n),x=(e,o,t,n)=>R(e,o,t,n)||L(e,o,t,n),H=s.map(a);function T(e,o,t){const n=e.get(o);if(!n)return[];const r=a(o),s=n.role,d="pawn"===s?(c=n.color,(e,o,t,n)=>"sente"===c?e===t&&o-1===n:e===t&&o+1===n):"knight"===s?function(e){return(o,t,n,r)=>1===B(o,n)&&2===B(t,r)&&("sente"===e?r<t:r>t)}(n.color):"bishop"===s?E:"rook"===s?L:"king"===s?R:"silver"===s?function(e){return(o,t,n,r)=>B(o,n)<2&&B(t,r)<2&&t!==r&&("sente"===e?o!==n||r<t:o!==n||r>t)}(n.color):"lance"===s?function(e){return(o,t,n,r)=>"sente"===e?o===n&&r<t:o===n&&t<r}(n.color):"horse"===s?A:"dragon"===s?x:function(e){return(o,t,n,r)=>B(o,n)<2&&B(t,r)<2&&("sente"===e?r<=t||o===n:r>=t||o===n)}(n.color);var c;return H.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&d(r[0],r[1],e[0],e[1])&&e[0]<t.files&&e[1]<t.ranks)).map(i)}function $(e,o,t){return"sente"===t?0===o[1]:o[1]===e.ranks-1}function K(e,o,t){const n=o.color,r=o.role;return s.filter((o=>{const s=e.get(o),i=a(o);return(!s||s.color!==n)&&i[0]<t.files&&i[1]<t.ranks&&("pawn"===r||"lance"===r?!$(t,i,n):"knight"!==r||!function(e,o,t){return $(e,o,t)||("sente"===t?1===o[1]:o[1]===e.ranks-2)}(t,i,n))}))}function j(e,o,t=1){const n=e.hands.handMap.get(o.color);n&&e.hands.roles.includes(o.role)&&n.set(o.role,(n.get(o.role)||0)+t)}function F(e,o,t=1){const n=e.hands.handMap.get(o.color),r=null==n?void 0:n.get(o.role);n&&r&&n.set(o.role,Math.max(r-t,0))}function z(e,o){var t;o.classList.toggle("promotion",!!e.promotion.current);let n=o.firstElementChild;for(;n;){const o=n.firstElementChild,r={role:o.sgRole,color:o.sgColor},s=(null===(t=e.hands.handMap.get(r.color))||void 0===t?void 0:t.get(r.role))||0,i=!!e.selectedPiece&&f(r,e.selectedPiece)&&!e.droppable.spare;n.classList.toggle("selected",("both"===e.activeColor||e.activeColor===e.turnColor)&&i),n.classList.toggle("preselected","both"!==e.activeColor&&e.activeColor!==e.turnColor&&i),n.classList.toggle("drawing",!!e.drawable.piece&&f(e.drawable.piece,r)),n.classList.toggle("current-pre",!!e.predroppable.current&&f(e.predroppable.current.piece,r)),n.dataset.nb=s.toString(),n=n.nextElementSibling}}function N(e){e.premovable.current&&(e.premovable.current=void 0,c(e.premovable.events.unset))}function G(e){e.predroppable.current&&(e.predroppable.current=void 0,c(e.predroppable.events.unset))}function X(e,o,t,n){const r=e.pieces.get(o),s=e.pieces.get(t);if(o===t||!r)return!1;const i=s&&s.color!==r.color?s:void 0,a=n&&J(e,r);return t!==e.selected&&o!==e.selected||ne(e),e.pieces.set(t,a||r),e.pieces.delete(o),e.lastDests=[o,t],e.check=void 0,c(e.events.move,o,t,n,i),c(e.events.change),i||!0}function Y(e,o,t,n){var r;const s=(null===(r=e.hands.handMap.get(o.color))||void 0===r?void 0:r.get(o.role))||0;if(!s&&!e.droppable.spare)return!1;const i=n&&J(e,o);return(t===e.selected||!e.droppable.spare&&1===s&&e.selectedPiece&&f(e.selectedPiece,o))&&ne(e),e.pieces.set(t,i||o),e.lastDests=[t],e.check=void 0,e.droppable.spare||F(e,o),c(e.events.drop,o,t,n),c(e.events.change),!0}function U(e,o,t,n){const r=X(e,o,t,n);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),r}function I(e,o,t,n){const r=Y(e,o,t,n);return r&&(e.movable.dests=void 0,e.droppable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),r}function Q(e,o,t,n){const r=n||e.promotion.forceDropPromotion(o,t);if(ae(e,o,t)){if(I(e,o,t,r))return ne(e),c(e.droppable.events.after,o,t,r,{premade:!1}),!0}else if(ue(e,o,t))return function(e,o,t,n){N(e),e.predroppable.current={piece:o,key:t,prom:n},c(e.predroppable.events.set,o,t,n)}(e,o,t,r),ne(e),!0;return ne(e),!1}function V(e,o,t,n){const r=n||e.promotion.forceMovePromotion(o,t);if(ie(e,o,t)){const n=U(e,o,t,r);if(n){ne(e);const s={premade:!1};return!0!==n&&(s.captured=n),c(e.movable.events.after,o,t,r,s),!0}}else if(le(e,o,t))return function(e,o,t,n){G(e),e.premovable.current={orig:o,dest:t,prom:n},c(e.premovable.events.set,o,t,n)}(e,o,t,r),ne(e),!0;return ne(e),!1}function W(e,o,t){const n=J(e,o);return!(e.viewOnly||e.promotion.current||!n)&&(e.promotion.current={piece:o,promotedPiece:n,key:t,dragged:!!e.draggable.current},e.hovered=t,!0)}function Z(e,o,t){return!(!function(e,o,t){return!e.droppable.spare&&e.promotion.dropPromotionDialog(o,t)}(e,o,t)||!ae(e,o,t)&&!ue(e,o,t)||!W(e,o,t))&&(c(e.promotion.events.initiated),!0)}function _(e,o,t){if(function(e,o,t){return!!e.pieces.get(o)&&e.promotion.movePromotionDialog(o,t)}(e,o,t)&&(ie(e,o,t)||le(e,o,t))){const n=e.pieces.get(o);if(n&&W(e,n,t))return c(e.promotion.events.initiated),!0}return!1}function J(e,o){const t=e.promotion.promotesTo(o.role);return t&&{color:o.color,role:t}}function ee(e,o,t,n){if(c(e.events.select,o),(e.selectable.enabled||n)&&e.selectedPiece){if(Q(e,e.selectedPiece,o,t))return}else if(e.selected){if(e.selected===o&&!e.draggable.enabled)return void ne(e);if((e.selectable.enabled||n)&&e.selected!==o&&V(e,e.selected,o,t))return}(re(e,o)||de(e,o))&&function(e,o){ne(e),e.selected=o,te(e)}(e,o)}function oe(e,o,t){var n;c(e.events.pieceSelect,o),!e.draggable.enabled&&e.selectedPiece&&f(e.selectedPiece,o)||!t&&!(null===(n=e.hands.handMap.get(o.color))||void 0===n?void 0:n.get(o.role))?ne(e):(se(e,o)||ce(e,o))&&(!function(e,o){ne(e),e.selectedPiece=o,te(e)}(e,o),e.droppable.spare=!!t)}function te(e){e.premovable.dests=e.predroppable.dests=void 0,e.selected&&de(e,e.selected)?e.premovable.dests=T(e.pieces,e.selected,e.dimensions):e.selectedPiece&&ce(e,e.selectedPiece)&&(e.predroppable.dests=K(e.pieces,e.selectedPiece,e.dimensions))}function ne(e){e.selected=e.selectedPiece=e.premovable.dests=e.predroppable.dests=e.promotion.current=void 0}function re(e,o){const t=e.pieces.get(o);return!!t&&("both"===e.activeColor||e.activeColor===t.color&&e.turnColor===t.color)}function se(e,o){return"both"===e.activeColor||e.activeColor===o.color&&e.turnColor===o.color}function ie(e,o,t){var n,r;return o!==t&&re(e,o)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(o))||void 0===r?void 0:r.includes(t)))}function ae(e,o,t){var n,r;return se(e,o)&&(e.droppable.free||e.droppable.spare||!!(null===(r=null===(n=e.droppable.dests)||void 0===n?void 0:n.get(o.role))||void 0===r?void 0:r.includes(t)))}function de(e,o){const t=e.pieces.get(o);return!!t&&e.premovable.enabled&&e.activeColor===t.color&&e.turnColor!==t.color}function ce(e,o){return e.predroppable.enabled&&e.activeColor===o.color&&e.turnColor!==o.color}function le(e,o,t){return o!==t&&de(e,o)&&T(e.pieces,o,e.dimensions).includes(t)}function ue(e,o,t){const n=e.pieces.get(t);return ce(e,o)&&(!n||n.color!==e.activeColor)&&K(e.pieces,o,e.dimensions).includes(t)}function pe(e,o){return e.draggable.enabled&&("both"===e.activeColor||e.activeColor===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function fe(e){const o=e.premovable.current;if(!o)return!1;const t=o.orig,n=o.dest,r=o.prom;let s=!1;if(ie(e,t,n)){const o=U(e,t,n,r);if(o){const i={premade:!0};!0!==o&&(i.captured=o),c(e.movable.events.after,t,n,r,i),s=!0}}return N(e),s}function ge(e){const o=e.predroppable.current;if(!o)return!1;const t=o.piece,n=o.key,r=o.prom;let s=!1;return ae(e,t,n)&&I(e,t,n,r)&&(c(e.droppable.events.after,t,n,r,{premade:!0}),s=!0),G(e),s}function he(e){N(e),G(e),ne(e)}function me(e){e.promotion.current&&(ne(e),e.promotion.current=void 0,e.hovered=void 0,c(e.promotion.events.cancel))}function ve(e){e.activeColor=e.movable.dests=e.droppable.dests=e.draggable.current=e.animation.current=e.promotion.current=e.hovered=void 0,he(e)}function be(e){switch(e){case"p":return"pawn";case"l":return"lance";case"n":return"knight";case"s":return"silver";case"g":return"gold";case"b":return"bishop";case"r":return"rook";case"+p":return"tokin";case"+l":return"promotedlance";case"+n":return"promotedknight";case"+s":return"promotedsilver";case"+b":return"horse";case"+r":return"dragon";case"k":return"king";default:return}}const we={pawn:"p",lance:"l",knight:"n",silver:"s",gold:"g",bishop:"b",rook:"r",king:"k",tokin:"+p",promotedlance:"+l",promotedknight:"+n",promotedsilver:"+s",horse:"+b",dragon:"+r"};function Ce(e){const o=e.split("/"),t=o[0].split("");let n=0,r=0;for(const e of t){const o=e.charCodeAt(0);o<58&&o>47?r=10*r+o-48:"+"!==e&&(n+=r+1,r=0)}return n+=r,{files:n,ranks:o.length}}function ke(e,o){o.animation&&(Pe(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function ye(e,o){var t,n,r,s,a,d,c,l,u;(null===(t=o.movable)||void 0===t?void 0:t.dests)&&(e.movable.dests=void 0),(null===(n=o.droppable)||void 0===n?void 0:n.dests)&&(e.droppable.dests=void 0),(null===(r=o.drawable)||void 0===r?void 0:r.shapes)&&(e.drawable.shapes=[]),(null===(s=o.drawable)||void 0===s?void 0:s.autoShapes)&&(e.drawable.autoShapes=[]),(null===(a=o.drawable)||void 0===a?void 0:a.squares)&&(e.drawable.squares=[]),(null===(d=o.hands)||void 0===d?void 0:d.roles)&&(e.hands.roles=[]),Pe(e,o),(null===(c=o.sfen)||void 0===c?void 0:c.board)&&(e.dimensions=Ce(o.sfen.board),e.pieces=function(e,o){const t=new Map;let n=o.files-1,r=0;for(let s=0;s<e.length;s++)switch(e[s]){case" ":case"_":return t;case"/":if(++r,r>o.ranks-1)return t;n=o.files-1;break;default:{const o=e[s].charCodeAt(0),a=e[s+1]&&e[s+1].charCodeAt(0);if(o<58&&o>47)a&&a<58&&a>47?(n-=10*(o-48)+(a-48),s++):n-=o-48;else{const o=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=be(o);if(n>=0&&a){const d=e[s]===o||"+"+e[s]===o?"gote":"sente";t.set(i([n,r]),{role:a,color:d})}--n}}}return t}(o.sfen.board,e.dimensions),e.drawable.shapes=(null===(l=o.drawable)||void 0===l?void 0:l.shapes)||[]),(null===(u=o.sfen)||void 0===u?void 0:u.hands)&&(e.hands.handMap=function(e){const o=new Map,t=new Map;let n=0,r=1;for(let s=0;s<e.length;s++){const i=e[s].charCodeAt(0);if(i<58&&i>47)n=10*n+i-48,r=n;else{const i=("+"===e[s]&&e.length>s+1?"+"+e[++s]:e[s]).toLowerCase(),a=be(i);a&&("sente"==(e[s]===i||"+"+e[s]===i?"gote":"sente")?o.set(a,(o.get(a)||0)+r):t.set(a,(t.get(a)||0)+r)),n=0,r=1}}return new Map([["sente",o],["gote",t]])}(o.sfen.hands)),"check"in o&&function(e,o){if(e.check=void 0,!0===o&&(o=e.turnColor),o)for(const[t,n]of e.pieces)"king"===n.role&&n.color===o&&(e.check=t)}(e,o.check||!1),"lastDests"in o&&!o.lastDests?e.lastDests=void 0:o.lastDests&&(e.lastDests=o.lastDests),te(e),ke(e,o)}function Pe(e,o){for(const t in o)Me(e[t])&&Me(o[t])?Pe(e[t],o[t]):e[t]=o[t]}function Me(e){return"object"==typeof e}function Se(t,n){var r,s,i;const d=u(t.orientation),c=t.scaleDownPieces?.5:1,l=h(t.dimensions),p=n.squares,f=n.pieces,g=n.dragged,m=n.squareOver,w=n.promotion,C=t.pieces,P=t.animation.current,M=P?P.plan.anims:new Map,S=P?P.plan.fadings:new Map,O=P?P.plan.promotions:new Map,D=t.draggable.current,q=(null===(r=t.promotion.current)||void 0===r?void 0:r.dragged)?t.selected:void 0,B=function(e){var o,t;const n=new Map;if(e.lastDests&&e.highlight.lastDests)for(const o of e.lastDests)qe(n,o,"last-dest");e.check&&e.highlight.check&&qe(n,e.check,"check");e.hovered&&qe(n,e.hovered,"hover");if(e.selected){if("both"===e.activeColor||e.activeColor===e.turnColor?qe(n,e.selected,"selected"):qe(n,e.selected,"preselected"),e.movable.showDests){const t=null===(o=e.movable.dests)||void 0===o?void 0:o.get(e.selected);if(t)for(const o of t)qe(n,o,"dest"+(e.pieces.has(o)?" oc":""));const r=e.premovable.dests;if(r)for(const o of r)qe(n,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}}else if(e.selectedPiece&&e.droppable.showDests){const o=null===(t=e.droppable.dests)||void 0===t?void 0:t.get(e.selectedPiece.role);if(o)for(const e of o)qe(n,e,"dest");const r=e.predroppable.dests;if(r)for(const o of r)qe(n,o,"pre-dest"+(e.pieces.has(o)?" oc":""))}const r=e.premovable.current;r?(qe(n,r.orig,"current-pre"),qe(n,r.dest,"current-pre"+(r.prom?" prom":""))):e.predroppable.current&&qe(n,e.predroppable.current.key,"current-pre"+(e.predroppable.current.prom?" prom":""));for(const o of e.drawable.squares)qe(n,o.key,o.className);return n}(t),E=new Set,L=new Map;let R,A,x,H,T,$,K,j,F;for(!D&&(null==g?void 0:g.sgDragging)&&(g.sgDragging=!1,b(g,!1),m&&b(m,!1)),A=f.firstElementChild;A;){if(e(A))if(R=A.sgKey,x=C.get(R),T=M.get(R),$=S.get(R),K=O.get(R),H=y({color:A.sgColor,role:A.sgRole}),((null==D?void 0:D.started)&&(null===(s=D.fromBoard)||void 0===s?void 0:s.orig)===R||q&&q===R)&&!A.sgGhost?(A.sgGhost=!0,A.classList.add("ghost")):!A.sgGhost||D&&(null===(i=D.fromBoard)||void 0===i?void 0:i.orig)===R||q&&q===R||(A.sgGhost=!1,A.classList.remove("ghost")),!$&&A.sgFading&&(A.sgFading=!1,A.classList.remove("fading")),x){if(T&&A.sgAnimating&&(H===y(x)||K&&H===y(K))){const e=a(R);e[0]+=T[2],e[1]+=T[3],v(A,l(e,d),c)}else A.sgAnimating&&(A.sgAnimating=!1,A.classList.remove("anim"),v(A,l(a(R),d),c));H!==y(x)||$&&A.sgFading?$&&H===y($)?(A.sgFading=!0,A.classList.add("fading")):K&&H===y(K)?E.add(R):De(L,H,A):E.add(R)}else De(L,H,A);A=A.nextElementSibling}let z=p.firstElementChild;for(;z&&o(z);)z.className=B.get(z.sgKey)||"",z=z.nextElementSibling;for(const[e,o]of C){const t=O.get(e)||o;if(T=M.get(e),!E.has(e))if(j=L.get(y(t)),F=j&&j.pop(),F){F.sgKey=e,F.sgFading&&(F.sgFading=!1,F.classList.remove("fading"));const o=a(e);T&&(F.sgAnimating=!0,F.classList.add("anim"),o[0]+=T[2],o[1]+=T[3]),v(F,l(o,d),c)}else{const t=k("piece",y(o)),n=a(e);t.sgColor=o.color,t.sgRole=o.role,t.sgKey=e,T&&(t.sgAnimating=!0,n[0]+=T[2],n[1]+=T[3]),v(t,l(n,d),c),f.appendChild(t)}}for(const e of L.values())Oe(t,e);w&&function(e,o){const t=e.promotion.current,n=t&&t.key,r=t?[t.promotedPiece,t.piece]:[],s=function(e,o,t){return[e,o,t.map((e=>y(e))).join(" ")].join(" ")}(!!t,n,r);if(e.promotion.prevPromotionHash===s)return;if(e.promotion.prevPromotionHash=s,n){const s=u(e.orientation),i=a(n),d=t.piece.color,c=k("sg-promotion-square"),l=k("sg-promotion-choices");e.orientation!==d&&l.classList.add("reversed"),v(c,h(e.dimensions)(i,s),1);for(const e of r){const o=k("piece",y(e));o.sgColor=e.color,o.sgRole=e.role,l.appendChild(o)}o.innerHTML="",c.appendChild(l),o.appendChild(c),b(o,!0)}else b(o,!1)}(t,w)}function Oe(e,o){for(const t of o)e.dom.elements.board.pieces.removeChild(t)}function De(e,o,t){const n=e.get(o);n?n.push(t):e.set(o,[t])}function qe(e,o,t){const n=e.get(o);n?e.set(o,`${n} ${t}`):e.set(o,t)}function Be(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}const Ee="outsideArrow";function Le(e,o,t,n){const r=e.drawable,s=r.current,i=(null==s?void 0:s.dest)?s:void 0,d=!!s&&!i,c=new Map,l=new Map,p=()=>{const o=e.dom.bounds.board.bounds();return o&&o.width.toString()+o.height||""};for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[])){const o=ze(e.dest)?y(e.dest):e.dest;Ne(e.dest,e.orig)||c.set(o,(c.get(o)||0)+1)}for(const e of r.shapes.concat(i?[i]:[]).concat(r.autoShapes))e.piece&&!ze(e.orig)&&l.set(e.orig,e);const f=[...l.values()].map((e=>({shape:e,hash:Ae(e,c,!1,p)}))),g=r.shapes.concat(r.autoShapes).map((e=>({shape:e,hash:Ae(e,c,!1,p)})));i&&g.push({shape:i,hash:Ae(i,c,!0,p),current:!0});const m=g.map((e=>e.hash)).join(";")+(d?Ee:"");if(m===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=m;const b=o.querySelector("defs"),w=o.querySelector("g"),C=t.querySelector("g");if(function(e,o,t){const n=new Set;for(const o of e)Ne(o.shape.dest,o.shape.orig)||n.add(o.shape.brush);o&&n.add(o.brush);const r=new Set;let s=t.firstElementChild;for(;s;)r.add(s.getAttribute("sgKey")),s=s.nextElementSibling;for(const e of n)r.has(e)||t.appendChild(Ke(e))}(g,d?s:void 0,b),Re(g.filter((e=>!e.shape.customSvg&&(!e.shape.piece||e.current))),w,(o=>Te(e,o,c)),d),Re(g.filter((e=>e.shape.customSvg)),C,(o=>Te(e,o,c))),Re(f,n,(o=>function(e,{shape:o,hash:t}){if(!o.piece||ze(o.orig))return;const n=o.orig,r=(o.piece.scale||1)*(e.scaleDownPieces?.5:1),s=k("piece",y(o.piece));return s.setAttribute("sgHash",t),s.sgKey=n,s.sgScale=r,v(s,h(e.dimensions)(a(n),u(e.orientation)),e.scaleDownPieces?.5:1,r),s}(e,o))),!d&&s&&(s.arrow=void 0),d&&!s.arrow){const o=Ue(s.orig,e);if(o){const t=$e(s.brush,o,o,e.squareRatio,!0,!1,!0);t.setAttribute("sgHash",Ee),s.arrow=t,w.appendChild(t)}}}function Re(e,o,t,n){const r=new Map,s=[];for(const o of e)r.set(o.hash,!1);n&&r.set(Ee,!0);let i,a=o.firstElementChild;for(;a;)i=a.getAttribute("sgHash"),r.has(i)?r.set(i,!0):s.push(a),a=a.nextElementSibling;for(const e of s)o.removeChild(e);for(const n of e)if(!r.get(n.hash)){const e=t(n);e&&o.appendChild(e)}}function Ae({orig:e,dest:o,brush:t,piece:n,customSvg:r},s,i,a){return[i,(ze(e)||ze(o))&&a(),ze(e)?xe(e):e,ze(o)?xe(o):o,t,(s.get(ze(o)?y(o):o)||0)>1,n&&xe(n),r&&He(r)].filter((e=>e)).join(",")}function xe(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function He(e){let o=0;for(let t=0;t<e.length;t++)o=(o<<5)-o+e.charCodeAt(t)>>>0;return"custom-"+o.toString()}function Te(e,{shape:o,current:t,hash:n},r){const s=Ue(o.orig,e);if(!s)return;let i;if(o.customSvg)i=function(e,o,t){const[n,r]=o,s=je(Be("g"),{transform:`translate(${n},${r})`}),i=je(Be("svg"),{width:t[0],height:t[1],viewBox:`0 0 ${10*t[0]} ${10*t[1]}`});return s.appendChild(i),i.innerHTML=e,s}(o.customSvg,s,e.squareRatio);else{const n=!Ne(o.orig,o.dest)&&Ue(o.dest,e);if(n)i=$e(o.brush,s,n,e.squareRatio,!!t,(r.get(ze(o.dest)?y(o.dest):o.dest)||0)>1,!1);else if(Ne(o.dest,o.orig)){let n=e.squareRatio;if(ze(o.orig)){const t=e.dom.bounds.hands.pieceBounds().get(y(o.orig)),r=e.dom.bounds.board.bounds();if(t&&r){const o=t.height/(r.height/e.dimensions.files);n=[o*e.squareRatio[0],o*e.squareRatio[1]]}}i=function(e,o,t,n){const r=o,s=function(e){return[3/64*Xe(e),4/64*Xe(e)]}(t);return je(Be("ellipse"),{class:e,"stroke-width":s[n?0:1],fill:"none",cx:r[0],cy:r[1],rx:t[0]/2-s[1]/2,ry:t[1]/2-s[1]/2})}(o.brush,s,n,!!t)}}return i?(i.setAttribute("sgHash",n),i):void 0}function $e(e,o,t,n,r,s,i){const a=function(e,o){return(e?20:10)/64*Xe(o)}(s&&!r,n),d=o,c=t,l=c[0]-d[0],u=c[1]-d[1],p=Math.atan2(u,l),f=Math.cos(p)*a,g=Math.sin(p)*a;return je(Be("line"),{class:Ge(e,r,i),"stroke-width":Ye(r,n),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e+")",x1:d[0],y1:d[1],x2:c[0]-f,y2:c[1]-g})}function Ke(e){const o=je(Be("marker"),{id:"arrowhead-"+e,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return o.appendChild(je(Be("path"),{d:"M0,0 V4 L3,2 Z"})),o.setAttribute("sgKey",e),o}function je(e,o){for(const t in o)e.setAttribute(t,o[t]);return e}function Fe(e,o,t,n){return"sente"===o?[(t.files-1-e[0])*n[0],e[1]*n[1]]:[e[0]*n[0],(t.ranks-1-e[1])*n[1]]}function ze(e){return"object"==typeof e}function Ne(e,o){return ze(e)&&ze(o)&&f(e,o)||e===o}function Ge(e,o,t){return e+(o?" current":"")+(t?" outside":"")}function Xe(e){return(e[0]+e[1])/2}function Ye(e,o){return(e?8.5:10)/64*Xe(o)}function Ue(e,o){if(ze(e)){const t=o.dom.bounds.hands.pieceBounds().get(y(e)),n=o.dom.bounds.board.bounds(),r=u(o.orientation)?[.5,-.5]:[-.5,.5],s=t&&n&&q(t.left+t.width/2,t.top+t.height/2,u(o.orientation),o.dimensions,n);return s&&Fe([s[0]+r[0],s[1]+r[1]],o.orientation,o.dimensions,o.squareRatio)}return Fe(a(e),o.orientation,o.dimensions,o.squareRatio)}function Ie(e){var o;(null===(o=e.dom.elements.board)||void 0===o?void 0:o.svg)&&Le(e,e.dom.elements.board.svg,e.dom.elements.board.customSvg,e.dom.elements.board.freePieces)}const Qe=Ze(Ie);function Ve(e,o){const t=e.dom.elements.board;t&&(Se(e,t),o||Ie(e));const n=e.dom.elements.hands;n&&(n.top&&z(e,n.top),n.bottom&&z(e,n.bottom))}const We=Ze(Ve);function Ze(e){let o=!1;return(...t)=>{o||(o=!0,requestAnimationFrame((()=>{e(...t),o=!1})))}}function _e(e,o){return o.animation.enabled?function(e,o){const n=new Map(o.pieces),r=new Map([["sente",new Map(o.hands.handMap.get("sente"))],["gote",new Map(o.hands.handMap.get("gote"))]]),i=e(o),a=function(e,o,n){const r=new Map,i=[],a=new Map,d=new Map,c=[],l=[],p=new Map;for(const[o,t]of e)p.set(o,eo(o,t));for(const e of s){const o=n.pieces.get(e),t=p.get(e);o?t?f(o,t.piece)||(c.push(t),l.push(eo(e,o))):l.push(eo(e,o)):t&&c.push(t)}if(n.animation.hands)for(const e of t){const t=n.hands.handMap.get(e),r=o.get(e);if(r&&t)for(const[o,s]of r){const r={role:o,color:e};if((t.get(o)||0)<s){const e=n.dom.bounds.hands.pieceBounds().get(y(r)),o=n.dom.bounds.board.bounds();e&&o&&c.push({pos:q(e.left,e.top,u(n.orientation),n.dimensions,o),piece:r})}}}for(const e of l){const o=oo(e,c.filter((o=>{if(f(e.piece,o.piece))return!0;const t=n.promotion.promotesTo(o.piece.role),r=t&&{color:o.piece.color,role:t},s=n.promotion.promotesTo(e.piece.role),i=s&&{color:e.piece.color,role:s};return!!r&&f(e.piece,r)||!!i&&f(i,o.piece)})));if(o){const t=[o.pos[0]-e.pos[0],o.pos[1]-e.pos[1]];r.set(e.key,t.concat(t)),o.key&&i.push(o.key),!f(e.piece,o.piece)&&e.key&&d.set(e.key,o.piece)}}for(const e of c)e.key&&!i.includes(e.key)&&a.set(e.key,e.piece);return{anims:r,fadings:a,promotions:d}}(n,r,o);if(a.anims.size||a.fadings.size){const e=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:a},e||to(o,performance.now())}else We(o);return i}(e,o):Je(e,o)}function Je(e,o){const t=e(o);return We(o),t}function eo(e,o){return{key:e,pos:a(e),piece:o}}function oo(e,o){return o.sort(((o,t)=>p(e.pos,o.pos)-p(e.pos,t.pos)))[0]}function to(e,o){const t=e.animation.current;if(void 0===t)return void(e.dom.destroyed||Ve(e));const n=1-(o-t.start)*t.frequency;if(n<=0)e.animation.current=void 0,Ve(e);else{const o=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of t.plan.anims.values())e[2]=e[0]*o,e[3]=e[1]*o;Ve(e,!0),requestAnimationFrame(((o=performance.now())=>to(e,o)))}var r}const no=["primary","alternative0","alternative1","alternative2"];function ro(e){requestAnimationFrame((()=>{const o=e.drawable.current,t=e.dom.bounds.board.bounds();if(o&&t){const n=O(o.pos,u(e.orientation),e.dimensions,t)||D(o.pos,e.hands.roles,e.dom.bounds.hands.pieceBounds());if(o.dest===n||o.dest&&n&&Ne(n,o.dest)||(o.dest=n,Ve(e)),!o.dest&&o.arrow){const n=Fe(q(o.pos[0],o.pos[1],u(e.orientation),e.dimensions,t),e.orientation,e.dimensions,e.squareRatio);je(o.arrow,{x2:n[0]-e.squareRatio[0]/2,y2:n[1]-e.squareRatio[1]/2})}ro(e)}}))}function so(e,o){e.drawable.current&&(e.drawable.current.pos=w(o))}function io(e,o){const t=e.drawable.current;t&&(!function(e,o){if(!o.dest)return;const t=e=>Ne(o.orig,e.orig)&&Ne(o.dest,e.dest),n=o.piece;o.piece=void 0;const r=e.shapes.find(t),s=e.shapes.find((e=>t(e)&&n&&e.piece&&f(n,e.piece))),i=e.shapes.find((e=>t(e)&&n&&e.piece&&!f(n,e.piece)));r&&(e.shapes=e.shapes.filter((e=>!t(e))));ze(o.orig)||!n||s||(e.shapes.push({orig:o.orig,dest:o.orig,piece:n,brush:o.brush}),Ne(o.orig,o.dest)||e.shapes.push({orig:o.orig,dest:o.orig,brush:o.brush}));r&&!i&&r.brush===o.brush||e.shapes.push(o);uo(e)}(e.drawable,t),ao(e))}function ao(e){e.drawable.current&&(e.drawable.current=void 0,We(e))}function co(e){const o=e.drawable.shapes.length;(o||e.drawable.piece)&&(e.drawable.shapes=[],e.drawable.piece=void 0,We(e),o&&uo(e.drawable))}function lo(e){var o;const t=(e.shiftKey||e.ctrlKey)&&C(e),n=e.altKey||e.metaKey||(null===(o=e.getModifierState)||void 0===o?void 0:o.call(e,"AltGraph"));return no[(t?1:0)+(n?2:0)]}function uo(e){e.onChange&&e.onChange(e.shapes)}function po(e,o){var t;const n=e.dom.bounds.board.bounds(),r=w(o),s=n&&r&&O(r,u(e.orientation),e.dimensions,n);if(!s)return;const i=e.pieces.get(s),a=e.selected;a||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||co(e),!1!==o.cancelable&&(!o.touches||e.blockTouchScroll||e.selectedPiece||i||a||function(e,o,t){const n=u(e.orientation),r=Math.pow(t.width/e.dimensions.files,2);for(const s of e.pieces.keys()){const i=P(s,n,e.dimensions,t);if(p(i,o)<=r)return!0}return!1}(e,r,n))&&o.preventDefault();const d=!!e.premovable.current,l=!!e.predroppable.current;var f,g;e.selectable.deleteOnTouch?(g=s,(f=e).pieces.delete(g)&&c(f.events.change)):e.selected?_(e,e.selected,s)||(ie(e,e.selected,s)?_e((e=>ee(e,s)),e):ee(e,s)):e.selectedPiece?Z(e,e.selectedPiece,s)||(ae(e,e.selectedPiece,s)?_e((e=>ee(e,s)),e):ee(e,s)):ee(e,s);const h=e.selected===s,m=null===(t=e.dom.elements.board)||void 0===t?void 0:t.dragged;if(i&&m&&h&&pe(e,i)){const t="touchstart"===o.type;e.draggable.current={piece:i,pos:r,origPos:r,started:e.draggable.autoDistance&&!t,touch:t,originTarget:o.target,fromBoard:{orig:s,previouslySelected:a,keyHasChanged:!1}},m.sgColor=i.color,m.sgRole=i.role,m.className=`dragging ${y(i)}`,m.classList.toggle("touch",t),go(e)}else d&&N(e),l&&G(e);We(e)}function fo(e,o,t,n){var r;const s=e.selectedPiece,i=null===(r=e.dom.elements.board)||void 0===r?void 0:r.dragged,a=w(t),d="touchstart"===t.type;!s&&!n&&e.drawable.enabled&&e.drawable.eraseOnClick&&co(e),!n&&e.selectable.deleteOnTouch?F(e,o):oe(e,o,n);const c=!!e.premovable.current,l=!!e.predroppable.current;i&&e.selectedPiece&&pe(e,o)?(e.draggable.current={piece:e.selectedPiece,pos:a,origPos:a,touch:d,started:e.draggable.autoDistance&&!d,originTarget:t.target,fromOutside:{originBounds:n?void 0:e.dom.bounds.hands.pieceBounds().get(y(o)),leftOrigin:!1,previouslySelectedPiece:n?void 0:s}},i.sgColor=o.color,i.sgRole=o.role,i.className=`dragging ${y(o)}`,i.classList.toggle("touch",d),go(e)):(c&&N(e),l&&G(e)),We(e)}function go(e){requestAnimationFrame((()=>{var o,t,n,r;const s=e.draggable.current,i=null===(o=e.dom.elements.board)||void 0===o?void 0:o.dragged,d=e.dom.bounds.board.bounds();if(!s||!i||!d)return;(null===(t=s.fromBoard)||void 0===t?void 0:t.orig)&&(null===(n=e.animation.current)||void 0===n?void 0:n.plan.anims.has(s.fromBoard.orig))&&(e.animation.current=void 0);const c=s.fromBoard?e.pieces.get(s.fromBoard.orig):s.piece;if(c&&f(c,s.piece)){if(!s.started&&p(s.pos,s.origPos)>=Math.pow(e.draggable.distance,2)&&(s.started=!0,We(e)),s.started){m(i,[s.pos[0]-d.left-d.width/(2*e.dimensions.files),s.pos[1]-d.top-d.height/(2*e.dimensions.ranks)],e.scaleDownPieces?.5:1),i.sgDragging||(i.sgDragging=!0,b(i,!0));const o=O(s.pos,u(e.orientation),e.dimensions,d);s.fromBoard?s.fromBoard.keyHasChanged=s.fromBoard.keyHasChanged||s.fromBoard.orig!==o:s.fromOutside&&(s.fromOutside.leftOrigin=s.fromOutside.leftOrigin||!!s.fromOutside.originBounds&&!S(s.fromOutside.originBounds,s.pos)),o!==e.hovered&&(wo(e,o),s.touch&&(null===(r=e.dom.elements.board)||void 0===r?void 0:r.squareOver)&&(o&&e.draggable.showTouchSquareOverlay?(m(e.dom.elements.board.squareOver,((e,o)=>{const t=o.width/e.files,n=o.height/e.ranks;return(o,r)=>g(o,e,r,t,n)})(e.dimensions,d)(a(o),u(e.orientation)),1),b(e.dom.elements.board.squareOver,!0)):b(e.dom.elements.board.squareOver,!1)))}}else vo(e);go(e)}))}function ho(e,o){if(e.draggable.current&&(!o.touches||o.touches.length<2))e.draggable.current.pos=w(o);else if((e.selected||e.selectedPiece||e.highlight.hovered)&&!e.draggable.current&&(!o.touches||o.touches.length<2)){const t=e.dom.bounds.board.bounds(),n=t&&O(w(o),u(e.orientation),e.dimensions,t);n!==e.hovered&&wo(e,n)}}function mo(e,o){var t,n,r;const s=e.draggable.current;if(!s)return;if("touchend"===o.type&&!1!==o.cancelable&&o.preventDefault(),"touchend"===o.type&&s.originTarget!==o.target&&!s.fromOutside)return e.draggable.current=void 0,void(e.hovered&&!e.highlight.hovered&&wo(e,void 0));N(e),G(e);const i=w(o)||s.pos,a=e.dom.bounds.board.bounds(),d=a&&O(i,u(e.orientation),e.dimensions,a);if(d&&s.started&&(null===(t=s.fromBoard)||void 0===t?void 0:t.orig)!==d)s.fromOutside&&!Z(e,s.piece,d)?Q(e,s.piece,d):s.fromBoard&&!_(e,s.fromBoard.orig,d)&&V(e,s.fromBoard.orig,d);else if(e.draggable.deleteOnDropOff&&!d){if(s.fromBoard?e.pieces.delete(s.fromBoard.orig):s.fromOutside&&!e.droppable.spare&&F(e,s.piece),e.draggable.addToHandOnDropOff){const o=e.dom.bounds.hands.bounds(),t=o.get("top"),n=o.get("bottom");t&&S(t,s.pos)?j(e,{color:l(e.orientation),role:s.piece.role}):n&&S(n,s.pos)&&j(e,{color:e.orientation,role:s.piece.role})}c(e.events.change)}!s.fromBoard||s.fromBoard.orig!==s.fromBoard.previouslySelected&&!s.fromBoard.keyHasChanged||s.fromBoard.orig!==d&&d?(null===(n=s.fromOutside)||void 0===n?void 0:n.leftOrigin)||(null===(r=s.fromOutside)||void 0===r?void 0:r.originBounds)&&S(s.fromOutside.originBounds,s.pos)&&s.fromOutside.previouslySelectedPiece&&f(s.fromOutside.previouslySelectedPiece,s.piece)?ne(e):e.selectable.enabled||ne(e):ne(e),e.draggable.current=void 0,e.highlight.hovered||e.promotion.current||(e.hovered=void 0),We(e)}function vo(e){e.draggable.current&&(e.draggable.current=void 0,e.highlight.hovered||(e.hovered=void 0),ne(e),We(e))}function bo(e){return!e.isTrusted||void 0!==e.button&&0!==e.button||!!e.touches&&e.touches.length>1}function wo(e,o){var t;const n=null===(t=e.dom.elements.board)||void 0===t?void 0:t.squares.children;if(!n||e.promotion.current)return;const r=e.hovered;e.hovered=o;const s=u(e.orientation),i=e.hovered&&M(e.hovered,s,e.dimensions),a=void 0!==i&&n[i];a&&a.classList.add("hover");const d=r&&M(r,s,e.dimensions),c=void 0!==d&&n[d];c&&c.classList.remove("hover")}function Co(e,o){const n=k("sg-board"),r=function(e,o){const t=k("sg-squares");for(let n=0;n<e.ranks*e.files;n++){const r=k("sq");r.sgKey=i("sente"===o?[e.files-1-n%e.files,Math.floor(n/e.files)]:[n%e.files,e.files-1-Math.floor(n/e.files)]),t.appendChild(r)}return t}(o.dimensions,o.orientation);n.appendChild(r);const s=k("sg-pieces");let a,d,c,l,u,p;if(n.appendChild(s),o.viewOnly||(a=k("piece"),b(a,!1),n.appendChild(a),d=k("sg-promotion"),b(d,!1),n.appendChild(d),c=k("sg-square-over"),b(c,!1),n.appendChild(c)),o.drawable.visible&&(l=je(Be("svg"),{class:"sg-shapes",viewBox:`-${o.squareRatio[0]/2} -${o.squareRatio[1]/2} ${o.dimensions.files*o.squareRatio[0]} ${o.dimensions.ranks*o.squareRatio[1]}`}),l.appendChild(Be("defs")),l.appendChild(Be("g")),u=je(Be("svg"),{class:"sg-custom-svgs",viewBox:`0 0 ${o.dimensions.files*o.squareRatio[0]} ${o.dimensions.ranks*o.squareRatio[1]}`}),u.appendChild(Be("g")),p=k("sg-free-pieces"),n.appendChild(l),n.appendChild(u),n.appendChild(p)),o.coordinates.enabled){const e="gote"===o.orientation?" gote":"",t=function(e){switch(e){case 2:return["十二","十一","十","九","八","七","六","五","四","三","二","一"];case 3:return["l","k","j","i","h","g","f","e","d","c","b","a"];default:return["12","11","10","9","8","7","6","5","4","3","2","1"]}}(o.coordinates.notation);n.appendChild(yo(t,"ranks"+e,o.dimensions.ranks)),n.appendChild(yo(["12","11","10","9","8","7","6","5","4","3","2","1"],"files"+e,o.dimensions.files))}e.innerHTML="";const f=`d-${o.dimensions.files}x${o.dimensions.ranks}`;e.classList.forEach((o=>{"d-"===o.substring(0,2)&&o!==f&&e.classList.remove(o)})),e.classList.add("sg-wrap",f);for(const n of t)e.classList.toggle("orientation-"+n,o.orientation===n);let g;if(e.classList.toggle("manipulable",!o.viewOnly),e.appendChild(n),o.hands.inlined){const o=k("sg-hand-wrap"),t=k("sg-hand-wrap");e.insertBefore(t,n.nextElementSibling),e.insertBefore(o,n),g={top:o,bottom:t}}return{board:n,squares:r,pieces:s,promotion:d,squareOver:c,dragged:a,svg:l,customSvg:u,freePieces:p,hands:g}}function ko(e,o,n){const r=function(e,o){const t=k("sg-hand");for(const n of o){const o={role:n,color:e},r=k("sg-hp-wrap"),s=k("piece",y(o));s.sgColor=e,s.sgRole=n,r.appendChild(s),t.appendChild(r)}return t}("top"===o?l(n.orientation):n.orientation,n.hands.roles);e.innerHTML="";const s=`r-${n.hands.roles.length}`;e.classList.forEach((o=>{"r-"===o.substring(0,2)&&o!==s&&e.classList.remove(o)})),e.classList.add("sg-hand-wrap",`hand-${o}`,s),e.appendChild(r);for(const o of t)e.classList.toggle("orientation-"+o,n.orientation===o);return e.classList.toggle("manipulable",!n.viewOnly),r}function yo(e,o,t){const n=k("coords",o);let r;for(const o of e.slice(-t))r=k("coord"),r.textContent=o,n.appendChild(r);return n}function Po(e){e.dom.bounds.board.bounds.clear(),e.dom.bounds.hands.bounds.clear(),e.dom.bounds.hands.pieceBounds.clear()}function Mo(e){return()=>{Po(e),e.drawable.shapes.concat(e.drawable.autoShapes).some((e=>ze(e.orig)||ze(e.dest)))&&Qe(e)}}function So(o,t){if("ResizeObserver"in window&&new ResizeObserver(Mo(o)).observe(t.board),o.viewOnly)return;const n=t.pieces,r=t.promotion,s=function(e){return o=>{e.draggable.current?vo(e):e.drawable.current?ao(e):o.shiftKey||C(o)?e.drawable.enabled&&function(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?ne(e):he(e);const t=w(o),n=e.dom.bounds.board.bounds(),r=t&&n&&O(t,u(e.orientation),e.dimensions,n),s=e.drawable.piece;r&&(e.drawable.current={orig:r,dest:void 0,pos:t,piece:s,brush:lo(o)},ro(e))}(e,o):e.viewOnly||bo(o)||po(e,o)}}(o);if(n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("mousedown",s,{passive:!1}),(o.disableContextMenu||o.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault())),r){const t=t=>function(o,t){t.stopPropagation();const n=t.target,r=o.promotion.current;if(n&&e(n)&&r){const e={color:n.sgColor,role:n.sgRole},t=!f(r.piece,e);r.dragged||o.turnColor!==o.activeColor&&"both"!==o.activeColor?o.selected?V(o,o.selected,r.key,t):o.selectedPiece&&Q(o,o.selectedPiece,r.key,t):_e((e=>ee(e,r.key,t)),o),c(o.promotion.events.after,e)}else _e((e=>me(e)),o);o.promotion.current=void 0,We(o)}(o,t);r.addEventListener("click",t),o.disableContextMenu&&r.addEventListener("contextmenu",(e=>e.preventDefault()))}}function Oo(e,o){if("ResizeObserver"in window&&new ResizeObserver(Mo(e)).observe(o),e.viewOnly)return;const t=function(e){return o=>{if(e.promotion.current)return;const t=w(o),n=t&&D(t,e.hands.roles,e.dom.bounds.hands.pieceBounds());n&&(e.draggable.current?vo(e):e.drawable.current?ao(e):(e=>4===e.buttons||1===e.button)(o)?e.drawable.enabled&&(!1!==o.cancelable&&o.preventDefault(),function(e,o){e.drawable.piece&&f(e.drawable.piece,o)?e.drawable.piece=void 0:e.drawable.piece=o,We(e)}(e,n)):o.shiftKey||C(o)?e.drawable.enabled&&function(e,o,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?ne(e):he(e);const n=w(t);n&&(e.drawable.current={orig:o,dest:void 0,pos:n,brush:lo(t)},ro(e))}(e,n,o):e.viewOnly||bo(o)||(!1!==o.cancelable&&o.preventDefault(),fo(e,n,o)))}}(e);o.addEventListener("mousedown",t,{passive:!1}),o.addEventListener("touchstart",t,{passive:!1}),o.addEventListener("click",(()=>{e.promotion.current&&(me(e),We(e))})),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Do(e){const o=[];if("ResizeObserver"in window||o.push(qo(document.body,"shogiground.resize",Mo(e))),!e.viewOnly){const t=Bo(e,ho,so),n=Bo(e,mo,io);for(const e of["touchmove","mousemove"])o.push(qo(document,e,t));for(const e of["touchend","mouseup"])o.push(qo(document,e,n));o.push(qo(document,"scroll",(()=>Po(e)),{capture:!0,passive:!0})),o.push(qo(window,"resize",(()=>Po(e)),{passive:!0}))}return()=>o.forEach((e=>e()))}function qo(e,o,t,n){return e.addEventListener(o,t,n),()=>e.removeEventListener(o,t,n)}function Bo(e,o,t){return n=>{e.drawable.current?e.drawable.enabled&&t(e,n):e.viewOnly||o(e,n)}}function Eo(e,o,t){if(e.dom.elements.hands||(e.dom.elements.hands={}),e.dom.wrapElements.hands||(e.dom.wrapElements.hands={}),o){const t=ko(o,"top",e);e.dom.wrapElements.hands.top=o,e.dom.elements.hands.top=t,Oo(e,t),z(e,t)}if(t){const o=ko(t,"bottom",e);e.dom.wrapElements.hands.bottom=t,e.dom.elements.hands.bottom=o,Oo(e,o),z(e,o)}(o||t)&&(e.dom.bounds.hands.bounds.clear(),e.dom.bounds.hands.pieceBounds.clear())}function Lo(e,o){var t,n,r,s;e.board&&function(e,o){const t=Co(o,e);t.hands&&Eo(e,t.hands.top,t.hands.bottom),e.dom.wrapElements.board=o,e.dom.elements.board=t,e.dom.bounds.board.bounds.clear(),So(e,t),e.drawable.prevSvgHash="",e.promotion.prevPromotionHash="",Se(e,t)}(o,e.board),e.hands&&!o.hands.inlined&&Eo(o,e.hands.top,e.hands.bottom),Qe(o),o.events.insert&&o.events.insert(e.board&&o.dom.elements.board,{top:(null===(t=e.hands)||void 0===t?void 0:t.top)&&(null===(n=o.dom.elements.hands)||void 0===n?void 0:n.top),bottom:(null===(r=e.hands)||void 0===r?void 0:r.bottom)&&(null===(s=o.dom.elements.hands)||void 0===s?void 0:s.bottom)})}function Ro(e){return{attach(o){Lo(o,e)},detach(o){!function(e,o){var t,n,r,s;e.board&&(o.dom.wrapElements.board=void 0,o.dom.elements.board=void 0,o.dom.bounds.board.bounds.clear()),o.dom.elements.hands&&o.dom.wrapElements.hands&&((null===(t=e.hands)||void 0===t?void 0:t.top)&&(o.dom.wrapElements.hands.top=void 0,o.dom.elements.hands.top=void 0),(null===(n=e.hands)||void 0===n?void 0:n.bottom)&&(o.dom.wrapElements.hands.bottom=void 0,o.dom.elements.hands.bottom=void 0),((null===(r=e.hands)||void 0===r?void 0:r.top)||(null===(s=e.hands)||void 0===s?void 0:s.bottom))&&(o.dom.bounds.hands.bounds.clear(),o.dom.bounds.hands.pieceBounds.clear()))}(o,e)},set(o,t){var n,r,s;function i(e,o){return e.split(".").reduce(((e,o)=>e&&e[o]),o)}const a=(null===(n=o.sfen)||void 0===n?void 0:n.board)&&Ce(o.sfen.board);["orientation","viewOnly","coordinates.enabled","coordinates.notation","drawable.visible","hands.inlined"].some((t=>{const n=i(t,o);return n&&n!==i(t,e)}))||!(!a||a.files===e.dimensions.files&&a.ranks===e.dimensions.ranks)||!(!(null===(r=o.hands)||void 0===r?void 0:r.roles)||!o.hands.roles.every(((o,t)=>o===e.hands.roles[t])))?(!function(e){ne(e),N(e),G(e),me(e),e.animation.current=e.draggable.current=e.hovered=void 0}(e),ye(e,o),Lo(e.dom.wrapElements,e)):(ke(e,o),((null===(s=o.sfen)||void 0===s?void 0:s.board)&&!t?_e:Je)((e=>ye(e,o)),e))},state:e,getBoardSfen:()=>function(e,o){const t=n.slice(0,o.files).reverse();return r.slice(0,o.ranks).map((o=>t.map((t=>{const n=e.get(t+o);if(n){const e=we[n.role];return"sente"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()))}(e.pieces,e.dimensions),getHandsSfen:()=>function(e,o){var t,n;let r="",s="";for(const i of o){const o=null===(t=e.get("sente"))||void 0===t?void 0:t.get(i),a=null===(n=e.get("gote"))||void 0===n?void 0:n.get(i);o&&(r+=o>1?o.toString()+we[i]:we[i]),a&&(s+=a>1?a.toString()+we[i]:we[i])}return r||s?r.toUpperCase()+s:"-"}(e.hands.handMap,e.hands.roles),toggleOrientation(){!function(e){e.orientation=l(e.orientation),e.animation.current=e.draggable.current=e.promotion.current=e.hovered=e.selected=e.selectedPiece=void 0}(e),Lo(e.dom.wrapElements,e)},move(o,t,n){_e((e=>X(e,o,t,n||e.promotion.forceMovePromotion(o,t))),e)},drop(o,t,n,r){_e((e=>{e.droppable.spare=!!r,Y(e,o,t,n||e.promotion.forceDropPromotion(o,t))}),e)},setPieces(o){_e((e=>function(e,o){for(const[t,n]of o)n?e.pieces.set(t,n):e.pieces.delete(t)}(e,o)),e)},addToHand(o,t){Je((e=>j(e,o,t)),e)},removeFromHand(o,t){Je((e=>F(e,o,t)),e)},selectSquare(o,t,n){o?_e((e=>ee(e,o,t,n)),e):e.selected&&(ne(e),We(e))},selectPiece(o,t){o?Je((e=>oe(e,o,t)),e):e.selectedPiece&&(ne(e),We(e))},playPremove(){if(e.premovable.current){if(_e(fe,e))return!0;We(e)}return!1},playPredrop(){if(e.predroppable.current){if(_e(ge,e))return!0;We(e)}return!1},cancelPremove(){Je(N,e)},cancelPredrop(){Je(G,e)},cancelMove(){Je((e=>{he(e),vo(e)}),e)},stop(){Je((e=>{ve(e)}),e)},setAutoShapes(o){Je((e=>e.drawable.autoShapes=o),e)},setShapes(o){Je((e=>e.drawable.shapes=o),e)},setSquareHighlights(o){Je((e=>e.drawable.squares=o),e)},dragNewPiece(o,t,n){fo(e,o,t,n)},destroy(){ve(e),e.dom.unbind(),e.dom.destroyed=!0}}}return function(e,o){const t={pieces:new Map,dimensions:{files:9,ranks:9},orientation:"sente",turnColor:"sente",activeColor:"both",viewOnly:!1,squareRatio:[11,12],disableContextMenu:!0,blockTouchScroll:!1,scaleDownPieces:!0,coordinates:{enabled:!0,notation:0},highlight:{lastDests:!0,check:!0,hovered:!1},animation:{enabled:!0,hands:!0,duration:250},hands:{inlined:!1,handMap:new Map([["sente",new Map],["gote",new Map]]),roles:["rook","bishop","gold","silver","knight","lance","pawn"]},movable:{free:!0,showDests:!0,events:{}},droppable:{free:!0,showDests:!0,spare:!1,events:{}},premovable:{enabled:!0,showDests:!0,events:{}},predroppable:{enabled:!0,showDests:!0,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,showTouchSquareOverlay:!0,deleteOnDropOff:!1,addToHandOnDropOff:!1},selectable:{enabled:!0,deleteOnTouch:!1},promotion:{movePromotionDialog:()=>!1,forceMovePromotion:()=>!1,dropPromotionDialog:()=>!1,forceDropPromotion:()=>!1,promotesTo:()=>{},events:{},prevPromotionHash:""},events:{},drawable:{enabled:!0,visible:!0,eraseOnClick:!0,shapes:[],autoShapes:[],squares:[],prevSvgHash:""}};return ye(t,e||{}),t.dom={wrapElements:o||{},elements:{},bounds:{board:{bounds:d((()=>{var e;return null===(e=t.dom.elements.board)||void 0===e?void 0:e.pieces.getBoundingClientRect()}))},hands:{bounds:d((()=>{const e=new Map,o=t.dom.elements.hands;return(null==o?void 0:o.top)&&e.set("top",o.top.getBoundingClientRect()),(null==o?void 0:o.bottom)&&e.set("bottom",o.bottom.getBoundingClientRect()),e})),pieceBounds:d((()=>{const e=new Map,o=t.dom.elements.hands;if(null==o?void 0:o.top){let t=o.top.firstElementChild;for(;t;){const o=t.firstElementChild,n={role:o.sgRole,color:o.sgColor};e.set(y(n),o.getBoundingClientRect()),t=t.nextElementSibling}}if(null==o?void 0:o.bottom){let t=o.bottom.firstElementChild;for(;t;){const o=t.firstElementChild,n={role:o.sgRole,color:o.sgColor};e.set(y(n),o.getBoundingClientRect()),t=t.nextElementSibling}}return e}))}},unbind:Do(t),destroyed:!1},o&&Lo(o,t),Ro(t)}}();
